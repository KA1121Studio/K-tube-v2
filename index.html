
          const grid = el('channelVideos');
          let loading = false;
          const loadMore = async () => {
            if (loading) return;
            loading = true;
            try {
              const chData = await pipedFetch(`/channel/${channelId}`);
              for (const v of chData.relatedStreams || chData.videos || []) {
                const card = await makeVideoCard(v);
                grid.appendChild(card);
              }
            } catch (e) {
              console.error(e);
              grid.innerHTML += `<div style="color:#c00">読み込み失敗</div>`;
            } finally {
              loading = false;
            }
          };
          const sentinel = el('channelSentinel');
          const io = new IntersectionObserver(entries => {
            entries.forEach(ent => { if (ent.isIntersecting) loadMore(); });
          }, { rootMargin: '400px' });
          io.observe(sentinel);
          observerMap.set(`channel_${channelId}`, io);
          loadMore();
        } catch (e) {
          app.innerHTML = `<div style="color:#c00">チャンネル読み込み失敗: ${escapeHtml(e.message)}</div>`;
        }
      }

      function escapeHtml(s = '') {
        return String(s)
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#39;');
      }
    </script>

    <!-- パスワード画面部分（変更なし） -->
    <script>
      const correctPassword = "manabinotobira";
      const input = document.getElementById('passwordInput');
      const btn = document.getElementById('passwordBtn');
      const msg = document.getElementById('passwordMsg');
      const screen = document.getElementById('passwordScreen');
      const content = document.getElementById('mainContent');
      btn.addEventListener('click', () => {
        if(input.value === correctPassword){
          screen.style.display = 'none';
          content.style.display = 'block';
        } else {
          msg.textContent = '利用コードが違います';
          input.value = '';
          input.focus();
        }
      });
      input.addEventListener('keydown', e => {
        if(e.key === 'Enter') btn.click();
      });
      window.addEventListener('load', () => {
        fetch('https://teaching-materials-r4zf.onrender.com/', { mode: 'no-cors' }).catch(()=>{});
        fetch('https://teaching-materials-r4zf.onrender.com/watch.html?id=dummy', { mode: 'no-cors' }).catch(()=>{});
      });
    </script>
</body>
</html>

